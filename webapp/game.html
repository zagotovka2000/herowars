<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Wars Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .user-info {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            margin: 5px 10px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e74c3c;
        }

        .tabs {
            display: flex;
            background: #34495e;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab-button:hover {
            background: #2c3e50;
        }

        .tab-button.active {
            background: #e74c3c;
        }

        .tab-content {
            padding: 20px;
            min-height: 400px;
        }

        .hero-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .hero-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .hero-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .hero-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 10px 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: transform 0.2s;
        }

        .upgrade-btn:hover {
            transform: scale(1.05);
        }

        .upgrade-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .team-builder {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .team-slot {
            background: #f8f9fa;
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .team-slot.filled {
            border: 2px solid #27ae60;
            background: #d5f4e6;
        }

        .battle-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            font-weight: bold;
            margin: 20px auto;
            display: block;
            transition: transform 0.2s;
        }

        .battle-btn:hover {
            transform: scale(1.05);
        }

        .battle-log {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            .team-builder {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .hero-stats {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Hero Wars</h1>
            <p>–°–æ–±–µ—Ä–∏ –∫–æ–º–∞–Ω–¥—É –∏ —Å—Ç–∞–Ω—å –ª–µ–≥–µ–Ω–¥–æ–π!</p>
        </div>

        <div class="user-info" id="user-info">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('heroes')">üèπ –ú–æ–∏ –ì–µ—Ä–æ–∏</button>
            <button class="tab-button" onclick="showTab('team')">‚öîÔ∏è –ö–æ–º–∞–Ω–¥–∞</button>
            <button class="tab-button" onclick="showTab('battle')">üéØ –ë–∏—Ç–≤–∞</button>
        </div>

        <div id="heroes-tab" class="tab-content">
            <h2>–í–∞—à–∏ –≥–µ—Ä–æ–∏</h2>
            <div id="heroes-list" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ—Ä–æ–µ–≤...</div>
        </div>

        <div id="team-tab" class="tab-content" style="display:none">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</h2>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ 5 –≥–µ—Ä–æ–µ–≤ –¥–ª—è –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã:</p>
            <div class="team-builder" id="team-builder">
                <div class="team-slot" data-position="1">–ü–æ–∑–∏—Ü–∏—è 1</div>
                <div class="team-slot" data-position="2">–ü–æ–∑–∏—Ü–∏—è 2</div>
                <div class="team-slot" data-position="3">–ü–æ–∑–∏—Ü–∏—è 3</div>
                <div class="team-slot" data-position="4">–ü–æ–∑–∏—Ü–∏—è 4</div>
                <div class="team-slot" data-position="5">–ü–æ–∑–∏—Ü–∏—è 5</div>
            </div>
            <button class="upgrade-btn" onclick="saveTeam()" style="background: #3498db;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
            <div id="team-message"></div>
        </div>

        <div id="battle-tab" class="tab-content" style="display:none">
            <h2>–ê—Ä–µ–Ω–∞ –±–∏—Ç–≤</h2>
            <p>–°—Ä–∞–∑–∏—Ç–µ—Å—å —Å —Å–ª—É—á–∞–π–Ω—ã–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º!</p>
            <button class="battle-btn" onclick="findBattle()">
                ‚öîÔ∏è –ù–∞–π—Ç–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            </button>
            <div id="battle-result"></div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userData = null;
        let heroes = [];
        let selectedTeam = [];
        let tg = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        function initTelegramApp() {
            try {
                tg = Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É
                tg.setHeaderColor('#2c3e50');
                tg.setBackgroundColor('#667eea');
                
                console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                loadGameData();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App:', error);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–∞–∂–µ –µ—Å–ª–∏ Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω
                loadGameData();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
        async function loadGameData() {
            try {
                const tgUser = Telegram.WebApp.initDataUnsafe?.user;
                
                if (!tgUser) {
                    document.getElementById('user-info').innerHTML = 
                        '<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.</div>';
                    return;
                }

                const response = await fetch('/api/game-data', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        telegramId: tgUser.id,
                        username: tgUser.username || tgUser.first_name
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                userData = data.user;
                heroes = data.heroes || [];
                
                renderUserInfo();
                renderHeroes();
                renderTeamBuilder();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('user-info').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
                document.getElementById('heroes-list').innerHTML = 
                    `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–µ—Ä–æ–µ–≤</div>`;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function renderUserInfo() {
            if (!userData) return;
            
            document.getElementById('user-info').innerHTML = `
                <div class="stat">
                    <div>üèÜ –£—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value">${userData.level}</div>
                </div>
                <div class="stat">
                    <div>üí∞ –ó–æ–ª–æ—Ç–æ</div>
                    <div class="stat-value">${userData.gold}</div>
                </div>
                <div class="stat">
                    <div>üíé –°–∞–º–æ—Ü–≤–µ—Ç—ã</div>
                    <div class="stat-value">${userData.gems}</div>
                </div>
                <div class="stat">
                    <div>üéØ –ì–µ—Ä–æ–µ–≤</div>
                    <div class="stat-value">${heroes.length}</div>
                </div>
            `;
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≥–µ—Ä–æ–µ–≤
        function renderHeroes() {
            const container = document.getElementById('heroes-list');
            
            if (!heroes || heroes.length === 0) {
                container.innerHTML = '<div class="error">‚ùå –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥–µ—Ä–æ–µ–≤</div>';
                return;
            }

            container.innerHTML = heroes.map(hero => `
                <div class="hero-card">
                    <h3>${hero.name} (–£—Ä. ${hero.level})</h3>
                    <div class="hero-stats">
                        <div class="stat-item">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: ${hero.health}</div>
                        <div class="stat-item">‚öîÔ∏è –ê—Ç–∞–∫–∞: ${hero.attack}</div>
                        <div class="stat-item">üõ°Ô∏è –ó–∞—â–∏—Ç–∞: ${hero.defense}</div>
                        <div class="stat-item">üèÉ –°–∫–æ—Ä–æ—Å—Ç—å: ${hero.speed}</div>
                        <div class="stat-item">üéØ –ö—Ä–∏—Ç: ${(hero.criticalChance * 100).toFixed(1)}%</div>
                        <div class="stat-item">üí• –£—Ä–æ–Ω –∫—Ä–∏—Ç–∞: ${hero.criticalDamage.toFixed(1)}x</div>
                    </div>
                    <button class="upgrade-btn" 
                            onclick="upgradeHero(${hero.id})"
                            ${userData.gold < hero.level * 100 ? 'disabled' : ''}>
                        üöÄ –£–ª—É—á—à–∏—Ç—å (${hero.level * 100} –∑–æ–ª–æ—Ç–∞)
                    </button>
                </div>
            `).join('');
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
        function renderTeamBuilder() {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã
            console.log('Team builder ready');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // –£–±—Ä–∞—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(`${tabName}-tab`).style.display = 'block';
            
            // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
            event.target.classList.add('active');
        }

        // –£–ª—É—á—à–µ–Ω–∏–µ –≥–µ—Ä–æ—è
        async function upgradeHero(heroId) {
            try {
                const hero = heroes.find(h => h.id === heroId);
                if (!hero) {
                    alert('–ì–µ—Ä–æ–π –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }

                if (userData.gold < hero.level * 100) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –ù—É–∂–Ω–æ: ${hero.level * 100}`);
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
                if (tg && tg.sendData) {
                    tg.sendData(JSON.stringify({
                        action: 'upgrade_hero',
                        heroId: heroId,
                        userId: userData.id
                    }));
                } else {
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    const response = await fetch('/api/upgrade-hero', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ heroId, userId: userData.id })
                    });
                    
                    if (response.ok) {
                        alert('–ì–µ—Ä–æ–π —É–ª—É—á—à–µ–Ω!');
                        loadGameData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –≥–µ—Ä–æ—è');
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è –≥–µ—Ä–æ—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –≥–µ—Ä–æ—è: ' + error.message);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã
        async function saveTeam() {
            alert('–§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
        }

        // –ü–æ–∏—Å–∫ –±–∏—Ç–≤—ã
        async function findBattle() {
            const battleResult = document.getElementById('battle-result');
            battleResult.innerHTML = '<div class="loading">üîç –ü–æ–∏—Å–∫ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞...</div>';
            
            try {
                // –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –±–∏—Ç–≤—ã
                setTimeout(() => {
                    battleResult.innerHTML = `
                        <div class="error">
                            ‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –±–∏—Ç–≤ —á–µ—Ä–µ–∑ Web App –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.<br>
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /battle –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —á–∞—Ç–µ –±–æ—Ç–∞.
                        </div>
                    `;
                }, 2000);
                
            } catch (error) {
                battleResult.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –±–æ—Ç–∞
        function handleBotMessage(data) {
            console.log('Received data from bot:', data);
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏—à–µ–¥—à–∏—Ö –æ—Ç –±–æ—Ç–∞
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            initTelegramApp();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram Web App
        Telegram.WebApp.onEvent('webAppDataReceived', (event) => {
            try {
                const data = JSON.parse(event.data);
                handleBotMessage(data);
            } catch (error) {
                console.error('Error parsing web app data:', error);
            }
        });
    </script>
</body>
</html>
