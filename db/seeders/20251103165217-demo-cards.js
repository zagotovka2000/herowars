'use strict';

const { v4: uuidv4 } = require('uuid');

module.exports = {
  up: async (queryInterface, Sequelize) => {
    // Сначала создадим тестового пользователя, если его нет
    const testUser = await queryInterface.rawSelect('Users', {
      where: { telegramId: 123456789 }
    }, ['id']);

    let userId;
    if (!testUser) {
      userId = uuidv4();
      await queryInterface.bulkInsert('Users', [{
        id: userId,
        telegramId: 123456789,
        username: 'test_user',
        gameNik: 'TestPlayer',
        level: 1,
        experience: 0,
        energy: 100,
        maxEnergy: 100,
        lastEnergyUpdate: new Date(),
        gold: 1000,
        crystals: 50,
        rank: JSON.stringify({}),
        trophy: 1000,
        arenaRating: 1000,
        campaignProgress: JSON.stringify({}),
        dailyQuestsRefresh: new Date(),
        freeChestAvailableAt: new Date(),
        createdAt: new Date(),
        updatedAt: new Date()
      }]);
    } else {
      userId = testUser;
    }

    // Создаем 10 тестовых карточек для битв
    const cards = [
      {
        id: uuidv4(),
        userId: userId,
        name: 'Воин Тени',
        color: 'red',
        rank: 1,
        baseAttack: 85,
        baseHealth: 120,
        baseArmor: 5,
        baseCriticalChance: 0.15,
        currentHealth: 120,
        superMeter: 0,
        superAttackMultiplier: 2.0,
        level: 5,
        experience: 0,
        isInDeck: true,
        slotPosition: 0,
        equippedItems: JSON.stringify([{ type: 'weapon', attack: 10 }]),
        maxHealth: 120,
        currentSuperMeter: 0,
        baseSuperMultiplier: 2.0,
        abilities: JSON.stringify(['shadow_strike', 'dodge']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Лесной Страж',
        color: 'green',
        rank: 1,
        baseAttack: 65,
        baseHealth: 150,
        baseArmor: 8,
        baseCriticalChance: 0.10,
        currentHealth: 150,
        superMeter: 0,
        superAttackMultiplier: 1.8,
        level: 4,
        experience: 0,
        isInDeck: true,
        slotPosition: 1,
        equippedItems: JSON.stringify([{ type: 'armor', defense: 5 }]),
        maxHealth: 150,
        currentSuperMeter: 0,
        baseSuperMultiplier: 1.8,
        abilities: JSON.stringify(['heal', 'nature_armor']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Ледяной Маг',
        color: 'blue',
        rank: 2,
        baseAttack: 95,
        baseHealth: 90,
        baseArmor: 3,
        baseCriticalChance: 0.20,
        currentHealth: 90,
        superMeter: 0,
        superAttackMultiplier: 2.5,
        level: 6,
        experience: 0,
        isInDeck: true,
        slotPosition: 2,
        equippedItems: JSON.stringify([{ type: 'staff', magic: 15 }]),
        maxHealth: 90,
        currentSuperMeter: 0,
        baseSuperMultiplier: 2.5,
        abilities: JSON.stringify(['freeze', 'ice_shield']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Танк Железный',
        color: 'orange',
        rank: 2,
        baseAttack: 45,
        baseHealth: 200,
        baseArmor: 15,
        baseCriticalChance: 0.05,
        currentHealth: 200,
        superMeter: 0,
        superAttackMultiplier: 1.5,
        level: 5,
        experience: 0,
        isInDeck: true,
        slotPosition: 3,
        equippedItems: JSON.stringify([{ type: 'shield', defense: 10 }]),
        maxHealth: 200,
        currentSuperMeter: 0,
        baseSuperMultiplier: 1.5,
        abilities: JSON.stringify(['taunt', 'shield_bash']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Охотник',
        color: 'green',
        rank: 1,
        baseAttack: 75,
        baseHealth: 110,
        baseArmor: 4,
        baseCriticalChance: 0.25,
        currentHealth: 110,
        superMeter: 0,
        superAttackMultiplier: 2.2,
        level: 4,
        experience: 0,
        isInDeck: true,
        slotPosition: 4,
        equippedItems: JSON.stringify([{ type: 'bow', attack: 12 }]),
        maxHealth: 110,
        currentSuperMeter: 0,
        baseSuperMultiplier: 2.2,
        abilities: JSON.stringify(['double_shot', 'critical_hit']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Пират',
        color: 'red',
        rank: 1,
        baseAttack: 80,
        baseHealth: 100,
        baseArmor: 3,
        baseCriticalChance: 0.18,
        currentHealth: 100,
        superMeter: 0,
        superAttackMultiplier: 2.1,
        level: 3,
        experience: 0,
        isInDeck: false,
        slotPosition: null,
        equippedItems: JSON.stringify([{ type: 'saber', attack: 8 }]),
        maxHealth: 100,
        currentSuperMeter: 0,
        baseSuperMultiplier: 2.1,
        abilities: JSON.stringify(['pirate_rage', 'loot']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Некромант',
        color: 'blue',
        rank: 3,
        baseAttack: 90,
        baseHealth: 85,
        baseArmor: 2,
        baseCriticalChance: 0.22,
        currentHealth: 85,
        superMeter: 0,
        superAttackMultiplier: 2.8,
        level: 7,
        experience: 0,
        isInDeck: false,
        slotPosition: null,
        equippedItems: JSON.stringify([{ type: 'tome', magic: 20 }]),
        maxHealth: 85,
        currentSuperMeter: 0,
        baseSuperMultiplier: 2.8,
        abilities: JSON.stringify(['summon_undead', 'life_drain']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Паладин',
        color: 'orange',
        rank: 2,
        baseAttack: 70,
        baseHealth: 140,
        baseArmor: 10,
        baseCriticalChance: 0.12,
        currentHealth: 140,
        superMeter: 0,
        superAttackMultiplier: 1.9,
        level: 5,
        experience: 0,
        isInDeck: false,
        slotPosition: null,
        equippedItems: JSON.stringify([{ type: 'holy_sword', attack: 10 }]),
        maxHealth: 140,
        currentSuperMeter: 0,
        baseSuperMultiplier: 1.9,
        abilities: JSON.stringify(['holy_light', 'divine_protection']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Ассасин',
        color: 'gray',
        rank: 1,
        baseAttack: 95,
        baseHealth: 80,
        baseArmor: 1,
        baseCriticalChance: 0.30,
        currentHealth: 80,
        superMeter: 0,
        superAttackMultiplier: 3.0,
        level: 4,
        experience: 0,
        isInDeck: false,
        slotPosition: null,
        equippedItems: JSON.stringify([{ type: 'dagger', attack: 15 }]),
        maxHealth: 80,
        currentSuperMeter: 0,
        baseSuperMultiplier: 3.0,
        abilities: JSON.stringify(['backstab', 'smoke_bomb']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      },
      {
        id: uuidv4(),
        userId: userId,
        name: 'Друид',
        color: 'green',
        rank: 2,
        baseAttack: 60,
        baseHealth: 130,
        baseArmor: 6,
        baseCriticalChance: 0.08,
        currentHealth: 130,
        superMeter: 0,
        superAttackMultiplier: 1.7,
        level: 5,
        experience: 0,
        isInDeck: false,
        slotPosition: null,
        equippedItems: JSON.stringify([{ type: 'staff', magic: 12 }]),
        maxHealth: 130,
        currentSuperMeter: 0,
        baseSuperMultiplier: 1.7,
        abilities: JSON.stringify(['shape_shift', 'nature_heal']),
        battleStats: JSON.stringify({ battles: 0, wins: 0, superAttacks: 0 }),
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ];

    await queryInterface.bulkInsert('Cards', cards, {});
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.bulkDelete('Cards', null, {});
    await queryInterface.bulkDelete('Users', { telegramId: 123456789 }, {});
  }
};
